<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecting...</title>
  <script>
    (function () {
      // ---------- cookie utils ----------
      function getCookie(name) {
        var m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([$?*|{}()[\\]\\/+^])/g,'\\$1') + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
      }
      function setCookie(name, value, opts) {
        var maxAge = (opts && opts.maxAge) ? opts.maxAge : 31536000; // 1y
        var parts = [
          name + '=' + encodeURIComponent(value),
          'Max-Age=' + maxAge,
          'Path=/',
          'SameSite=Lax'
        ];
        if (location.protocol === 'https:') parts.push('Secure');
        try { if (location.hostname.endsWith('plura.io')) parts.push('Domain=.plura.io'); } catch (e) {}
        document.cookie = parts.join('; ');
      }
      function delCookie(name) {
        var parts = [ name + '=', 'Max-Age=0', 'Path=/' ];
        if (location.protocol === 'https:') parts.push('Secure');
        try { if (location.hostname.endsWith('plura.io')) parts.push('Domain=.plura.io'); } catch (e) {}
        document.cookie = parts.join('; ');
      }

      // ---------- lang mapping ----------
      function mapLang(lang) {
        if (!lang) return 'en';
        var l = lang.toLowerCase();
        if (l.startsWith('ko')) return 'ko';
        if (l.startsWith('ja')) return 'ja';
        return 'en';
      }

      // ---------- redirect helpers ----------
      function goToLang(lang) {
        var origin = location.origin;
        var targets = [
          origin + '/' + lang + '/index.html',
          origin + '/' + lang + '/',                 // 디렉터리 인덱스
          'https://www.plura.io/' + lang + '/index.html',
          'https://www.plura.io/' + lang + '/'
        ];
        // 첫 후보로 이동
        location.replace(targets[0]);
        // 1.2초 내 타이틀이 'Redirecting...' 그대로면 폴백 시도
        setTimeout(function(){
          if (document.title.indexOf('Redirecting') !== -1) {
            location.replace(targets[2]);
          }
        }, 1200);
      }

      document.addEventListener('DOMContentLoaded', function () {
        var path = location.pathname;

        // 언어 경로에 이미 진입한 경우: 쿠키만 보정하고 종료
        var m = path.match(/^\/(ko|ja|en)(\/|$)/);
        if (m) {
          var cur = m[1];
          if (getCookie('px_lang') !== cur) setCookie('px_lang', cur);
          try { document.documentElement.setAttribute('lang', cur); } catch (e) {}
          return;
        }

        // 루트 또는 /index.html 에서만 동작
        if (path === '/' || path === '/index.html') {
          // 마이그레이션: legacy lang -> px_lang
          var legacy = getCookie('lang');
          if (legacy && !getCookie('px_lang')) { setCookie('px_lang', mapLang(legacy)); delCookie('lang'); }

          var lang = getCookie('px_lang');
          if (!lang) {
            lang = mapLang(navigator.language || navigator.userLanguage);
            setCookie('px_lang', lang);
          }
          goToLang(lang);
        }
      });
    })();
  </script>
</head>
<body>
  <p>Loading ...</p>
</body>
</html>
