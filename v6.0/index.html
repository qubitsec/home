<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redirecting...</title>
  <script>
    (function () {
      /* ---------- cookie utils (no regex) ---------- */
      function getCookie(name){
        var cs=('; '+document.cookie).split('; '+name+'=');
        return cs.length<2 ? null : decodeURIComponent(cs.pop().split(';').shift());
      }
      function setCookie(name, value){
        var parts = [
          name + '=' + encodeURIComponent(value),
          'Max-Age=31536000',
          'Path=/',
          'SameSite=Lax'
        ];
        if (location.protocol === 'https:') parts.push('Secure');
        try { if (location.hostname.endsWith('plura.io')) parts.push('Domain=.plura.io'); } catch(e){}
        document.cookie = parts.join('; ');
      }
      function delCookie(name){
        var parts = [ name + '=', 'Max-Age=0', 'Path=/' ];
        if (location.protocol === 'https:') parts.push('Secure');
        try { if (location.hostname.endsWith('plura.io')) parts.push('Domain=.plura.io'); } catch(e){}
        document.cookie = parts.join('; ');
      }

      /* ---------- mapping ---------- */
      function mapLang(l){
        if (!l) return 'en';
        l = l.toLowerCase();
        if (l.indexOf('ko') === 0) return 'ko';
        if (l.indexOf('ja') === 0) return 'ja';
        return 'en';
      }
      function mapRegionFromLang(lang){
        return (lang === 'ja') ? 'jp' : 'kr'; // ko→kr, ja→jp, 기타→kr
      }

      document.addEventListener('DOMContentLoaded', function(){
        var path = location.pathname;

        // 이미 언어 경로면: 두 쿠키 보정 후 종료(루프 방지)
        var m = /^\/(ko|ja|en)(\/|$)/.exec(path);
        if (m) {
          var curLang = m[1];
          var wantRegion = mapRegionFromLang(curLang);
          if (getCookie('px_lang') !== curLang) setCookie('px_lang', curLang);
          if (getCookie('px_region') !== wantRegion) setCookie('px_region', wantRegion);
          try { document.documentElement.setAttribute('lang', curLang); } catch(e){}
          return;
        }

        // 루트(/ 또는 /index.html)에서만 리디렉트 수행
        if (path === '/' || path === '/index.html') {
          // (선택) 구 쿠키 마이그레이션
          var legacy = getCookie('lang');
          if (legacy && !getCookie('px_lang')) { setCookie('px_lang', mapLang(legacy)); delCookie('lang'); }

          var lang = getCookie('px_lang');
          if (!lang) {
            lang = mapLang(navigator.language || navigator.userLanguage);
            setCookie('px_lang', lang);
          }
          // region도 보정/생성
          var region = getCookie('px_region') || mapRegionFromLang(lang);
          setCookie('px_region', region);

          // 실제 컨텐츠가 /{lang}/index.html 에 존재해야 함
          location.replace('/' + lang + '/index.html');
        }
      });
    })();
  </script>
</head>
<body>
  <p>Loading ...</p>
</body>
</html>
